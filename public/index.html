<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tarefas</title>
</head>
<body>
    <h1>üìù Lista de Tarefas</h1>
    
    <!-- Login/Registro -->
    <div id="auth">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Senha">
        <input type="text" id="name" placeholder="Nome (s√≥ para registro)">
        <br><br>
        <button onclick="login()">Entrar</button>
        <button onclick="register()">Registrar</button>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
        <p id="user"></p>
        <button onclick="logout()">Sair</button>
        
        <h3>Nova Tarefa</h3>
        <input type="text" id="title" placeholder="T√≠tulo da tarefa">
        <select id="priority">
            <option value="1">Alta</option>
            <option value="2">M√©dia</option>
            <option value="3">Baixa</option>
        </select>
        <button onclick="addTodo()">Adicionar</button>
        
        <h3>Minhas Tarefas</h3>
        <ul id="todos"></ul>
    </div>

    <script>
        const API = window.location.origin;
        let token = null;

        async function register() {
            const res = await fetch(`${API}/auth/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    name: document.getElementById('name').value
                })
            });
            
            if (res.ok) {
                alert('Registrado! Agora fa√ßa login.');
            } else {
                const error = await res.json();
                alert('Erro: ' + (error.error || 'Falha no registro'));
            }
        }

        async function login() {
            const res = await fetch(`${API}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                })
            });
            
            if (res.ok) {
                const data = await res.json();
                token = data.access_token;
                document.getElementById('auth').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('user').textContent = `Ol√°, ${data.user.name || data.user.email}!`;
                loadTodos();
            } else {
                const error = await res.json();
                alert('Erro: ' + (error.error || 'Login inv√°lido'));
            }
        }

        function logout() {
            token = null;
            document.getElementById('auth').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }

        async function addTodo() {
            const res = await fetch(`${API}/todos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    title: document.getElementById('title').value,
                    priority: parseInt(document.getElementById('priority').value)
                })
            });
            
            if (res.ok) {
                document.getElementById('title').value = '';
                loadTodos();
            }
        }

        async function loadTodos() {
            const res = await fetch(`${API}/todos`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            
            if (res.ok) {
                const data = await res.json();
                const list = document.getElementById('todos');
                list.innerHTML = '';
                
                data.items.forEach(todo => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                               onchange="toggleTodo(${todo.id}, this.checked)">
                        ${todo.title} (Prioridade: ${todo.priority})
                        <button onclick="deleteTodo(${todo.id})">Excluir</button>
                    `;
                    list.appendChild(li);
                });
            }
        }

        async function toggleTodo(id, completed) {
            await fetch(`${API}/todos/${id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({completed})
            });
            loadTodos();
        }

        async function deleteTodo(id) {
            if (confirm('Excluir tarefa?')) {
                await fetch(`${API}/todos/${id}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                loadTodos();
            }
        }
    </script>
</body>
</html>